name: "Continuous Integration"

on:
  push:
#    branches:
#      - master
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: true
      matrix:
        machine: [
            imx23evk,
            imx25pdk,
            imx28evk,
            imx51evk,
            imx53ard,
            imx53qsb,
            imx6qdlsabreauto,
            imx6qdlsabresd,
            imx6slevk,
            imx6sllevk,
            imx6sxsabreauto,
            imx6sxsabresd,
            imx6ulevk,
            imx6ullevk,
            imx7dsabresd,
            imx7ulpevk,
            imx8mmevk,
            imx8mnevk,
            imx8mqevk,
            imx8qmmek,
            imx8qxpmek,
            ls1012afrwy,
            ls1012ardb,
            ls1021atwr,
            ls1028ardb,
            ls1043ardb,
            ls1046afrwy,
            ls1046ardb,
            ls1088ardb,
            ls1088ardb-pb,
            ls2080ardb,
            ls2088ardb,
            lx2160ardb,
            mpc8548cds,
            p1020rdb,
            p2020rdb,
            p2041rdb,
            p3041ds,
            p4080ds,
            p5040ds-64b,
            p5040ds,
            t1024rdb-64b,
            t1024rdb,
            t1042d4rdb-64b,
            t1042d4rdb,
            t2080rdb-64b,
            t2080rdb,
            t4240rdb-64b,
            t4240rdb,
        ]
        bsp: [mainline, nxp]

    env:
      BRANCH: master

    container:
      image: ossystems/github-actions-yocto-builder:latest
      env:
        WORKSPACE: /opt/build
      volumes:
        - ${{ github.workspace }}:/opt/build
      options: --privileged

    steps:
      - name: Prepare the container
        shell: bash
        run: |
          sudo sysctl fs.inotify.max_user_watches=524288
          sudo chown builder:builder ${WORKSPACE}

      - name: Checkout required repositories
        shell: bash
        run: |
          echo Cloning Poky repository
          git clone git://git.yoctoproject.org/poky --depth 1 -b $BRANCH
          echo
          echo Poky commit is:
          git --git-dir ${WORKSPACE}/poky/.git log -1
          rm -rf ${WORKSPACE}/poky/.git

          echo Cloning openembedded/meta-openembedded repository
          git clone git://github.com/openembedded/meta-openembedded --depth 1 -b $BRANCH
          echo
          echo openembedded/meta-openembedded commit is:
          git --git-dir ${WORKSPACE}/meta-openembedded/.git log -1
          rm -rf ${WORKSPACE}/meta-openembedded/.git

          echo Cloning UpdateHub/meta-updatehub repository
          git clone git://github.com/UpdateHub/meta-updatehub --depth 1 -b $BRANCH
          echo
          echo UpdateHub/meta-updatehub commit is:
          git --git-dir ${WORKSPACE}/meta-updatehub/.git log -1
          rm -rf ${WORKSPACE}/meta-updatehub/.git

      - name: Checkout this repository
        uses: actions/checkout@v2
        with:
          path: meta-freescale

      - name: Setup Yocto Project environment
        shell: bash
        run: |
          source ${WORKSPACE}/poky/oe-init-build-env ${WORKSPACE}/build

          cat <<EOF >> conf/local.conf
          MACHINE = "${{ matrix.machine }}"
          INHERIT += "rm_work"
          BB_DISKMON_DIRS = ""
          BB_GIT_SHALLOW = "1"
          BB_GIT_SHALLOW_DEPTH = "1"
          BB_GENERATE_SHALLOW_TARBALLS = "1"
          BB_NUMBER_THREADS = "2"
          PARALLEL_MAKE = "-j 2"
          IMX_DEFAULT_BSP = "${{ matrix.bsp }}"
          EOF
          sed -i "s/buildstats//g" conf/local.conf

          bitbake-layers add-layer ${WORKSPACE}/meta-freescale
          bitbake-layers add-layer ${WORKSPACE}/meta-openembedded/meta-oe
          bitbake-layers add-layer ${WORKSPACE}/meta-openembedded/meta-python

      - name: Check parsing for ${{ matrix.machine }} using ${{ matrix.bsp }} BSP
        shell: bash
        run: |
          source ${WORKSPACE}/poky/oe-init-build-env ${WORKSPACE}/build

          bitbake world -S none
